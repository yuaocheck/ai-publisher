<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Publisher - 多平台社交发布</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50" x-data="socialPublisher()">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="start.html" class="flex items-center">
                        <div class="h-8 w-8 bg-blue-600 rounded-lg flex items-center justify-center">
                            <span class="text-white font-bold text-sm">AI</span>
                        </div>
                        <span class="ml-2 text-xl font-bold text-gray-900">Publisher</span>
                    </a>
                </div>
                <div class="flex items-center">
                    <a href="start.html" class="text-gray-500 hover:text-gray-700 px-3 py-2 text-sm font-medium">
                        <i class="fas fa-arrow-left mr-2"></i>返回首页
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <div class="bg-gradient-to-r from-blue-600 to-purple-600 py-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg">
                <i class="fas fa-share-alt text-blue-600 text-2xl"></i>
            </div>
            <h1 class="text-4xl font-bold text-white mb-4">多平台社交发布</h1>
            <p class="text-xl text-blue-100 mb-8 max-w-3xl mx-auto">
                连接真实社交平台，一键发布到多个平台
            </p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
        <!-- Error/Success Messages -->
        <div x-show="errorMessage" class="mb-4 p-4 border rounded-lg bg-red-50 border-red-200 text-red-800">
            <div class="flex items-center">
                <i class="fas fa-exclamation-circle mr-2"></i>
                <span x-text="errorMessage"></span>
            </div>
        </div>
        
        <div x-show="successMessage" class="mb-4 p-4 border rounded-lg bg-green-50 border-green-200 text-green-800">
            <div class="flex items-center">
                <i class="fas fa-check-circle mr-2"></i>
                <span x-text="successMessage"></span>
            </div>
        </div>

        <!-- Platform Connections -->
        <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">
                <i class="fas fa-link text-blue-600 mr-2"></i>平台连接管理
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Twitter/X -->
                <div class="border border-gray-200 rounded-lg p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-black rounded-lg flex items-center justify-center">
                                <i class="fab fa-x-twitter text-white text-lg"></i>
                            </div>
                            <div class="ml-3">
                                <h3 class="font-semibold text-gray-900">Twitter/X</h3>
                                <p class="text-sm text-gray-500">280字符限制</p>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <span :class="platforms.twitter.connected ? 'text-green-600' : 'text-gray-400'" class="text-sm mr-2">
                                <i :class="platforms.twitter.connected ? 'fas fa-check-circle' : 'fas fa-times-circle'"></i>
                            </span>
                        </div>
                    </div>
                    <button 
                        @click="platforms.twitter.connected ? disconnectPlatform('twitter') : connectPlatform('twitter')"
                        :class="platforms.twitter.connected ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700'"
                        class="w-full text-white px-4 py-2 rounded-lg text-sm transition duration-200"
                    >
                        <span x-text="platforms.twitter.connected ? '断开连接' : '连接账号'"></span>
                    </button>
                </div>

                <!-- Facebook -->
                <div class="border border-gray-200 rounded-lg p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                                <i class="fab fa-facebook-f text-white text-lg"></i>
                            </div>
                            <div class="ml-3">
                                <h3 class="font-semibold text-gray-900">Facebook</h3>
                                <p class="text-sm text-gray-500">63,206字符限制</p>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <span :class="platforms.facebook.connected ? 'text-green-600' : 'text-gray-400'" class="text-sm mr-2">
                                <i :class="platforms.facebook.connected ? 'fas fa-check-circle' : 'fas fa-times-circle'"></i>
                            </span>
                        </div>
                    </div>
                    <button 
                        @click="platforms.facebook.connected ? disconnectPlatform('facebook') : connectPlatform('facebook')"
                        :class="platforms.facebook.connected ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700'"
                        class="w-full text-white px-4 py-2 rounded-lg text-sm transition duration-200"
                    >
                        <span x-text="platforms.facebook.connected ? '断开连接' : '连接账号'"></span>
                    </button>
                </div>

                <!-- Instagram -->
                <div class="border border-gray-200 rounded-lg p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg flex items-center justify-center">
                                <i class="fab fa-instagram text-white text-lg"></i>
                            </div>
                            <div class="ml-3">
                                <h3 class="font-semibold text-gray-900">Instagram</h3>
                                <p class="text-sm text-gray-500">2,200字符限制</p>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <span :class="platforms.instagram.connected ? 'text-green-600' : 'text-gray-400'" class="text-sm mr-2">
                                <i :class="platforms.instagram.connected ? 'fas fa-check-circle' : 'fas fa-times-circle'"></i>
                            </span>
                        </div>
                    </div>
                    <button 
                        @click="platforms.instagram.connected ? disconnectPlatform('instagram') : connectPlatform('instagram')"
                        :class="platforms.instagram.connected ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700'"
                        class="w-full text-white px-4 py-2 rounded-lg text-sm transition duration-200"
                    >
                        <span x-text="platforms.instagram.connected ? '断开连接' : '连接账号'"></span>
                    </button>
                </div>

                <!-- LinkedIn -->
                <div class="border border-gray-200 rounded-lg p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-blue-700 rounded-lg flex items-center justify-center">
                                <i class="fab fa-linkedin-in text-white text-lg"></i>
                            </div>
                            <div class="ml-3">
                                <h3 class="font-semibold text-gray-900">LinkedIn</h3>
                                <p class="text-sm text-gray-500">3,000字符限制</p>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <span :class="platforms.linkedin.connected ? 'text-green-600' : 'text-gray-400'" class="text-sm mr-2">
                                <i :class="platforms.linkedin.connected ? 'fas fa-check-circle' : 'fas fa-times-circle'"></i>
                            </span>
                        </div>
                    </div>
                    <button 
                        @click="platforms.linkedin.connected ? disconnectPlatform('linkedin') : connectPlatform('linkedin')"
                        :class="platforms.linkedin.connected ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700'"
                        class="w-full text-white px-4 py-2 rounded-lg text-sm transition duration-200"
                    >
                        <span x-text="platforms.linkedin.connected ? '断开连接' : '连接账号'"></span>
                    </button>
                </div>

                <!-- YouTube -->
                <div class="border border-gray-200 rounded-lg p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-red-600 rounded-lg flex items-center justify-center">
                                <i class="fab fa-youtube text-white text-lg"></i>
                            </div>
                            <div class="ml-3">
                                <h3 class="font-semibold text-gray-900">YouTube</h3>
                                <p class="text-sm text-gray-500">5,000字符限制</p>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <span :class="platforms.youtube.connected ? 'text-green-600' : 'text-gray-400'" class="text-sm mr-2">
                                <i :class="platforms.youtube.connected ? 'fas fa-check-circle' : 'fas fa-times-circle'"></i>
                            </span>
                        </div>
                    </div>
                    <button 
                        @click="platforms.youtube.connected ? disconnectPlatform('youtube') : connectPlatform('youtube')"
                        :class="platforms.youtube.connected ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700'"
                        class="w-full text-white px-4 py-2 rounded-lg text-sm transition duration-200"
                    >
                        <span x-text="platforms.youtube.connected ? '断开连接' : '连接账号'"></span>
                    </button>
                </div>

                <!-- TikTok -->
                <div class="border border-gray-200 rounded-lg p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-black rounded-lg flex items-center justify-center">
                                <i class="fab fa-tiktok text-white text-lg"></i>
                            </div>
                            <div class="ml-3">
                                <h3 class="font-semibold text-gray-900">TikTok</h3>
                                <p class="text-sm text-gray-500">150字符限制</p>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <span :class="platforms.tiktok.connected ? 'text-green-600' : 'text-gray-400'" class="text-sm mr-2">
                                <i :class="platforms.tiktok.connected ? 'fas fa-check-circle' : 'fas fa-times-circle'"></i>
                            </span>
                        </div>
                    </div>
                    <button 
                        @click="platforms.tiktok.connected ? disconnectPlatform('tiktok') : connectPlatform('tiktok')"
                        :class="platforms.tiktok.connected ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700'"
                        class="w-full text-white px-4 py-2 rounded-lg text-sm transition duration-200"
                    >
                        <span x-text="platforms.tiktok.connected ? '断开连接' : '连接账号'"></span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Content Creation -->
        <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">
                <i class="fas fa-edit text-purple-600 mr-2"></i>内容创作
            </h2>
            
            <div class="space-y-6">
                <!-- Content Input -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">内容文本</label>
                    <textarea 
                        x-model="content"
                        rows="6"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="输入您要发布的内容..."
                    ></textarea>
                    <div class="mt-2 flex justify-between text-sm text-gray-500">
                        <span>字符数: <span x-text="content.length"></span></span>
                        <span>建议长度: <span x-text="getRecommendedLength()"></span></span>
                    </div>
                </div>

                <!-- Media Upload -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">媒体文件</label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                        <input 
                            type="file" 
                            @change="handleFileUpload($event)"
                            accept="image/*,video/*"
                            class="hidden"
                            id="mediaUpload"
                            multiple
                        >
                        <label for="mediaUpload" class="cursor-pointer">
                            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                            <p class="text-gray-600">点击上传图片或视频</p>
                            <p class="text-sm text-gray-500 mt-2">支持 JPG, PNG, MP4, MOV 格式</p>
                        </label>
                    </div>
                    
                    <!-- Uploaded Files Preview -->
                    <div x-show="uploadedFiles.length > 0" class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4">
                        <template x-for="(file, index) in uploadedFiles" :key="index">
                            <div class="relative">
                                <img x-show="file.type.startsWith('image')" :src="file.preview" class="w-full h-24 object-cover rounded-lg">
                                <video x-show="file.type.startsWith('video')" :src="file.preview" class="w-full h-24 object-cover rounded-lg"></video>
                                <button 
                                    @click="removeFile(index)"
                                    class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs"
                                >
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Platform Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">选择发布平台</label>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <template x-for="(platform, key) in platforms" :key="key">
                            <label class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50">
                                <input 
                                    type="checkbox" 
                                    :value="key"
                                    x-model="selectedPlatforms"
                                    :disabled="!platform.connected"
                                    class="mr-3"
                                >
                                <div class="flex items-center">
                                    <i :class="platform.icon" class="text-lg mr-2"></i>
                                    <span x-text="platform.name" :class="platform.connected ? 'text-gray-900' : 'text-gray-400'"></span>
                                </div>
                            </label>
                        </template>
                    </div>
                </div>

                <!-- Scheduling -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">发布时间</label>
                        <select x-model="publishTime" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="now">立即发布</option>
                            <option value="scheduled">定时发布</option>
                        </select>
                    </div>
                    
                    <div x-show="publishTime === 'scheduled'">
                        <label class="block text-sm font-medium text-gray-700 mb-2">发布日期时间</label>
                        <input 
                            type="datetime-local" 
                            x-model="scheduledTime"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                    </div>
                </div>

                <!-- Publish Button -->
                <div class="text-center">
                    <button 
                        @click="publishContent()"
                        :disabled="publishing || selectedPlatforms.length === 0 || !content.trim()"
                        class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white px-8 py-3 rounded-lg font-medium transition duration-200"
                    >
                        <span x-show="!publishing">
                            <i class="fas fa-paper-plane mr-2"></i>
                            <span x-text="publishTime === 'now' ? '立即发布' : '定时发布'"></span>
                        </span>
                        <span x-show="publishing">
                            <i class="fas fa-spinner fa-spin mr-2"></i>发布中...
                        </span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Publishing History -->
        <div x-show="publishHistory.length > 0" class="bg-white rounded-xl shadow-lg p-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">
                <i class="fas fa-history text-green-600 mr-2"></i>发布历史
            </h2>

            <div class="space-y-4">
                <template x-for="(post, index) in publishHistory" :key="index">
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1">
                                <p class="text-gray-800 mb-2" x-text="post.content.substring(0, 100) + (post.content.length > 100 ? '...' : '')"></p>
                                <div class="flex flex-wrap gap-2">
                                    <template x-for="platform in post.platforms" :key="platform">
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                            <i :class="getPlatformIcon(platform)" class="mr-1"></i>
                                            <span x-text="getPlatformName(platform)"></span>
                                        </span>
                                    </template>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-500" x-text="formatDate(post.timestamp)"></div>
                                <div class="flex items-center mt-1">
                                    <span :class="post.status === 'success' ? 'text-green-600' : post.status === 'failed' ? 'text-red-600' : 'text-yellow-600'" class="text-sm">
                                        <i :class="post.status === 'success' ? 'fas fa-check-circle' : post.status === 'failed' ? 'fas fa-times-circle' : 'fas fa-clock'"></i>
                                        <span x-text="getStatusText(post.status)" class="ml-1"></span>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Platform Results -->
                        <div x-show="post.results && post.results.length > 0" class="mt-3 pt-3 border-t border-gray-100">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                <template x-for="result in post.results" :key="result.platform">
                                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                                        <div class="flex items-center">
                                            <i :class="getPlatformIcon(result.platform)" class="mr-2"></i>
                                            <span class="text-sm" x-text="getPlatformName(result.platform)"></span>
                                        </div>
                                        <div class="flex items-center">
                                            <span :class="result.success ? 'text-green-600' : 'text-red-600'" class="text-sm">
                                                <i :class="result.success ? 'fas fa-check' : 'fas fa-times'"></i>
                                            </span>
                                            <a x-show="result.success && result.url" :href="result.url" target="_blank" class="ml-2 text-blue-600 hover:text-blue-800">
                                                <i class="fas fa-external-link-alt text-xs"></i>
                                            </a>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- OAuth Connection Modal -->
        <div x-show="showOAuthModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click="closeOAuthModal()">
            <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4" @click.stop>
                <div class="text-center">
                    <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i :class="currentPlatform ? platforms[currentPlatform].icon : 'fas fa-link'" class="text-blue-600 text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">连接 <span x-text="currentPlatform ? platforms[currentPlatform].name : ''"></span></h3>
                    <p class="text-gray-600 mb-6">您将被重定向到官方授权页面</p>

                    <div class="space-y-4">
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <i class="fas fa-info-circle text-yellow-600 mr-2"></i>
                                <span class="text-sm text-yellow-800">请确保您已登录对应的社交媒体账号</span>
                            </div>
                        </div>

                        <div class="flex gap-3">
                            <button
                                @click="proceedWithOAuth()"
                                class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition duration-200"
                            >
                                继续授权
                            </button>
                            <button
                                @click="closeOAuthModal()"
                                class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg transition duration-200"
                            >
                                取消
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Publishing Progress Modal -->
        <div x-show="publishing" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
                <div class="text-center">
                    <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-spinner fa-spin text-blue-600 text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">正在发布内容...</h3>
                    <p class="text-gray-600 mb-4" x-text="publishingStatus"></p>

                    <div class="space-y-3">
                        <template x-for="(platform, index) in selectedPlatforms" :key="platform">
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center">
                                    <i :class="platforms[platform].icon" class="mr-3"></i>
                                    <span x-text="platforms[platform].name"></span>
                                </div>
                                <div class="flex items-center">
                                    <span x-show="publishingProgress[platform] === 'pending'" class="text-gray-500">
                                        <i class="fas fa-clock"></i>
                                    </span>
                                    <span x-show="publishingProgress[platform] === 'publishing'" class="text-blue-600">
                                        <i class="fas fa-spinner fa-spin"></i>
                                    </span>
                                    <span x-show="publishingProgress[platform] === 'success'" class="text-green-600">
                                        <i class="fas fa-check"></i>
                                    </span>
                                    <span x-show="publishingProgress[platform] === 'failed'" class="text-red-600">
                                        <i class="fas fa-times"></i>
                                    </span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function socialPublisher() {
            return {
                // Platform Configuration
                platforms: {
                    twitter: {
                        name: 'Twitter/X',
                        icon: 'fab fa-x-twitter',
                        connected: false,
                        limit: 280,
                        apiEndpoint: 'https://api.twitter.com/2/tweets',
                        authUrl: 'https://twitter.com/i/oauth2/authorize'
                    },
                    facebook: {
                        name: 'Facebook',
                        icon: 'fab fa-facebook-f',
                        connected: false,
                        limit: 63206,
                        apiEndpoint: 'https://graph.facebook.com/me/feed',
                        authUrl: 'https://www.facebook.com/v18.0/dialog/oauth'
                    },
                    instagram: {
                        name: 'Instagram',
                        icon: 'fab fa-instagram',
                        connected: false,
                        limit: 2200,
                        apiEndpoint: 'https://graph.facebook.com/me/media',
                        authUrl: 'https://api.instagram.com/oauth/authorize'
                    },
                    linkedin: {
                        name: 'LinkedIn',
                        icon: 'fab fa-linkedin-in',
                        connected: false,
                        limit: 3000,
                        apiEndpoint: 'https://api.linkedin.com/v2/ugcPosts',
                        authUrl: 'https://www.linkedin.com/oauth/v2/authorization'
                    },
                    youtube: {
                        name: 'YouTube',
                        icon: 'fab fa-youtube',
                        connected: false,
                        limit: 5000,
                        apiEndpoint: 'https://www.googleapis.com/youtube/v3/videos',
                        authUrl: 'https://accounts.google.com/oauth2/v2/auth'
                    },
                    tiktok: {
                        name: 'TikTok',
                        icon: 'fab fa-tiktok',
                        connected: false,
                        limit: 150,
                        apiEndpoint: 'https://open-api.tiktok.com/share/video/upload/',
                        authUrl: 'https://www.tiktok.com/auth/authorize/'
                    }
                },

                // Content Data
                content: '',
                uploadedFiles: [],
                selectedPlatforms: [],
                publishTime: 'now',
                scheduledTime: '',

                // Publishing State
                publishing: false,
                publishingStatus: '',
                publishingProgress: {},

                // OAuth State
                showOAuthModal: false,
                currentPlatform: null,

                // History
                publishHistory: [],

                // UI State
                errorMessage: '',
                successMessage: '',

                init() {
                    // 加载保存的连接状态
                    this.loadConnectionStatus();
                    // 加载发布历史
                    this.loadPublishHistory();
                    // 设置默认定时时间
                    this.setDefaultScheduledTime();
                    // 监听 OAuth 回调
                    this.handleOAuthCallback();
                },

                // Platform Connection Management
                connectPlatform(platform) {
                    this.currentPlatform = platform;
                    this.showOAuthModal = true;
                },

                disconnectPlatform(platform) {
                    this.platforms[platform].connected = false;
                    localStorage.removeItem(`${platform}_token`);
                    localStorage.removeItem(`${platform}_user`);
                    this.saveConnectionStatus();
                    this.showSuccess(`已断开与 ${this.platforms[platform].name} 的连接`);
                },

                proceedWithOAuth() {
                    if (!this.currentPlatform) return;

                    const platform = this.platforms[this.currentPlatform];
                    const authParams = this.buildOAuthParams(this.currentPlatform);
                    const authUrl = `${platform.authUrl}?${authParams}`;

                    // 打开授权窗口
                    const authWindow = window.open(authUrl, 'oauth', 'width=600,height=600');

                    // 监听授权完成
                    const checkClosed = setInterval(() => {
                        if (authWindow.closed) {
                            clearInterval(checkClosed);
                            this.closeOAuthModal();
                            // 检查授权结果
                            setTimeout(() => {
                                this.checkAuthResult(this.currentPlatform);
                            }, 1000);
                        }
                    }, 1000);
                },

                buildOAuthParams(platform) {
                    const baseParams = {
                        client_id: this.getClientId(platform),
                        redirect_uri: window.location.origin + '/oauth-callback.html',
                        response_type: 'code',
                        state: platform
                    };

                    // 平台特定参数
                    switch (platform) {
                        case 'twitter':
                            baseParams.scope = 'tweet.read tweet.write users.read';
                            baseParams.code_challenge_method = 'S256';
                            baseParams.code_challenge = this.generateCodeChallenge();
                            break;
                        case 'facebook':
                            baseParams.scope = 'pages_manage_posts,pages_read_engagement';
                            break;
                        case 'instagram':
                            baseParams.scope = 'user_profile,user_media';
                            break;
                        case 'linkedin':
                            baseParams.scope = 'w_member_social';
                            break;
                        case 'youtube':
                            baseParams.scope = 'https://www.googleapis.com/auth/youtube.upload';
                            break;
                        case 'tiktok':
                            baseParams.scope = 'user.info.basic,video.upload';
                            break;
                    }

                    return new URLSearchParams(baseParams).toString();
                },

                getClientId(platform) {
                    // 实际应用中这些应该从环境变量或配置文件中获取
                    const clientIds = {
                        twitter: 'your_twitter_client_id',
                        facebook: 'your_facebook_app_id',
                        instagram: 'your_instagram_client_id',
                        linkedin: 'your_linkedin_client_id',
                        youtube: 'your_youtube_client_id',
                        tiktok: 'your_tiktok_client_key'
                    };
                    return clientIds[platform] || 'demo_client_id';
                },

                generateCodeChallenge() {
                    // 简化的 PKCE code challenge 生成
                    return btoa(Math.random().toString(36).substring(2, 15) +
                               Math.random().toString(36).substring(2, 15));
                },

                checkAuthResult(platform) {
                    // 模拟授权成功（实际应用中需要处理真实的 OAuth 回调）
                    const success = Math.random() > 0.3; // 70% 成功率

                    if (success) {
                        this.platforms[platform].connected = true;
                        this.saveConnectionStatus();
                        this.showSuccess(`成功连接到 ${this.platforms[platform].name}！`);

                        // 模拟保存访问令牌
                        localStorage.setItem(`${platform}_token`, `demo_token_${Date.now()}`);
                        localStorage.setItem(`${platform}_user`, JSON.stringify({
                            id: `user_${Date.now()}`,
                            name: `Demo User`,
                            platform: platform
                        }));
                    } else {
                        this.showError(`连接 ${this.platforms[platform].name} 失败，请重试`);
                    }
                },

                handleOAuthCallback() {
                    // 处理 OAuth 回调（如果有）
                    const urlParams = new URLSearchParams(window.location.search);
                    const code = urlParams.get('code');
                    const state = urlParams.get('state');

                    if (code && state && this.platforms[state]) {
                        this.exchangeCodeForToken(state, code);
                    }
                },

                async exchangeCodeForToken(platform, code) {
                    try {
                        // 实际应用中需要通过后端服务器交换令牌
                        const response = await fetch('/api/oauth/token', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                platform: platform,
                                code: code,
                                redirect_uri: window.location.origin + '/oauth-callback.html'
                            })
                        });

                        if (response.ok) {
                            const data = await response.json();
                            localStorage.setItem(`${platform}_token`, data.access_token);
                            this.platforms[platform].connected = true;
                            this.saveConnectionStatus();
                            this.showSuccess(`成功连接到 ${this.platforms[platform].name}！`);
                        } else {
                            throw new Error('Token exchange failed');
                        }
                    } catch (error) {
                        console.error('OAuth token exchange error:', error);
                        this.showError(`连接 ${this.platforms[platform].name} 失败`);
                    }
                },

                // Content Publishing
                async publishContent() {
                    if (!this.content.trim()) {
                        this.showError('请输入要发布的内容');
                        return;
                    }

                    if (this.selectedPlatforms.length === 0) {
                        this.showError('请选择至少一个发布平台');
                        return;
                    }

                    if (this.publishTime === 'scheduled' && !this.scheduledTime) {
                        this.showError('请设置发布时间');
                        return;
                    }

                    this.publishing = true;
                    this.publishingStatus = '准备发布内容...';
                    this.initializePublishingProgress();

                    try {
                        const publishResults = [];

                        for (const platform of this.selectedPlatforms) {
                            this.publishingProgress[platform] = 'publishing';
                            this.publishingStatus = `正在发布到 ${this.platforms[platform].name}...`;

                            try {
                                const result = await this.publishToPlatform(platform);
                                publishResults.push({
                                    platform: platform,
                                    success: true,
                                    url: result.url,
                                    id: result.id
                                });
                                this.publishingProgress[platform] = 'success';
                            } catch (error) {
                                console.error(`发布到 ${platform} 失败:`, error);
                                publishResults.push({
                                    platform: platform,
                                    success: false,
                                    error: error.message
                                });
                                this.publishingProgress[platform] = 'failed';
                            }

                            // 添加延迟避免 API 限制
                            await this.delay(1000);
                        }

                        // 保存发布记录
                        this.savePublishRecord(publishResults);

                        const successCount = publishResults.filter(r => r.success).length;
                        const totalCount = publishResults.length;

                        if (successCount === totalCount) {
                            this.showSuccess(`成功发布到所有 ${totalCount} 个平台！`);
                        } else if (successCount > 0) {
                            this.showSuccess(`成功发布到 ${successCount}/${totalCount} 个平台`);
                        } else {
                            this.showError('发布失败，请检查网络连接和平台授权');
                        }

                        // 清空内容
                        this.content = '';
                        this.uploadedFiles = [];
                        this.selectedPlatforms = [];

                    } catch (error) {
                        console.error('发布过程出错:', error);
                        this.showError('发布过程中出现错误: ' + error.message);
                    } finally {
                        this.publishing = false;
                        this.publishingStatus = '';
                    }
                },

                async publishToPlatform(platform) {
                    const token = localStorage.getItem(`${platform}_token`);
                    if (!token) {
                        throw new Error('未找到访问令牌，请重新连接账号');
                    }

                    const platformConfig = this.platforms[platform];
                    const publishData = this.buildPublishData(platform);

                    // 实际 API 调用
                    const response = await fetch(platformConfig.apiEndpoint, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(publishData)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `HTTP ${response.status}`);
                    }

                    const result = await response.json();

                    // 返回统一格式的结果
                    return {
                        id: result.id || result.data?.id,
                        url: this.buildPostUrl(platform, result)
                    };
                },

                buildPublishData(platform) {
                    const baseData = {
                        text: this.content,
                        media: this.uploadedFiles.map(file => ({
                            type: file.type.startsWith('image') ? 'image' : 'video',
                            url: file.url || file.preview
                        }))
                    };

                    // 平台特定的数据格式
                    switch (platform) {
                        case 'twitter':
                            return {
                                text: this.content.substring(0, 280),
                                media: baseData.media.length > 0 ? {
                                    media_ids: baseData.media.map(m => m.url)
                                } : undefined
                            };

                        case 'facebook':
                            return {
                                message: this.content,
                                link: baseData.media.length > 0 ? baseData.media[0].url : undefined
                            };

                        case 'instagram':
                            return {
                                image_url: baseData.media.find(m => m.type === 'image')?.url,
                                caption: this.content.substring(0, 2200),
                                media_type: 'IMAGE'
                            };

                        case 'linkedin':
                            return {
                                author: `urn:li:person:${this.getCurrentUserId(platform)}`,
                                lifecycleState: 'PUBLISHED',
                                specificContent: {
                                    'com.linkedin.ugc.ShareContent': {
                                        shareCommentary: {
                                            text: this.content.substring(0, 3000)
                                        },
                                        shareMediaCategory: 'NONE'
                                    }
                                },
                                visibility: {
                                    'com.linkedin.ugc.MemberNetworkVisibility': 'PUBLIC'
                                }
                            };

                        case 'youtube':
                            return {
                                snippet: {
                                    title: this.content.substring(0, 100),
                                    description: this.content,
                                    tags: this.extractHashtags(this.content),
                                    categoryId: '22'
                                },
                                status: {
                                    privacyStatus: 'public'
                                }
                            };

                        case 'tiktok':
                            return {
                                video: {
                                    video_url: baseData.media.find(m => m.type === 'video')?.url
                                },
                                post_info: {
                                    title: this.content.substring(0, 150),
                                    privacy_level: 'SELF_ONLY',
                                    disable_duet: false,
                                    disable_comment: false,
                                    disable_stitch: false,
                                    video_cover_timestamp_ms: 1000
                                }
                            };

                        default:
                            return baseData;
                    }
                },

                buildPostUrl(platform, result) {
                    const userId = this.getCurrentUserId(platform);
                    const postId = result.id || result.data?.id;

                    const urlTemplates = {
                        twitter: `https://twitter.com/${userId}/status/${postId}`,
                        facebook: `https://facebook.com/${postId}`,
                        instagram: `https://instagram.com/p/${postId}`,
                        linkedin: `https://linkedin.com/feed/update/${postId}`,
                        youtube: `https://youtube.com/watch?v=${postId}`,
                        tiktok: `https://tiktok.com/@${userId}/video/${postId}`
                    };

                    return urlTemplates[platform] || '#';
                },

                getCurrentUserId(platform) {
                    const userData = localStorage.getItem(`${platform}_user`);
                    if (userData) {
                        const user = JSON.parse(userData);
                        return user.id || user.username || 'demo_user';
                    }
                    return 'demo_user';
                },

                extractHashtags(text) {
                    const hashtags = text.match(/#[\w\u4e00-\u9fff]+/g);
                    return hashtags ? hashtags.map(tag => tag.substring(1)) : [];
                },

                // File Management
                handleFileUpload(event) {
                    const files = Array.from(event.target.files);

                    files.forEach(file => {
                        if (file.size > 50 * 1024 * 1024) { // 50MB limit
                            this.showError(`文件 ${file.name} 太大，请选择小于 50MB 的文件`);
                            return;
                        }

                        const reader = new FileReader();
                        reader.onload = (e) => {
                            this.uploadedFiles.push({
                                name: file.name,
                                type: file.type,
                                size: file.size,
                                preview: e.target.result,
                                file: file
                            });
                        };
                        reader.readAsDataURL(file);
                    });
                },

                removeFile(index) {
                    this.uploadedFiles.splice(index, 1);
                },

                // Publishing Progress
                initializePublishingProgress() {
                    this.publishingProgress = {};
                    this.selectedPlatforms.forEach(platform => {
                        this.publishingProgress[platform] = 'pending';
                    });
                },

                // History Management
                savePublishRecord(results) {
                    const record = {
                        content: this.content,
                        platforms: this.selectedPlatforms,
                        results: results,
                        timestamp: new Date().toISOString(),
                        status: results.every(r => r.success) ? 'success' :
                               results.some(r => r.success) ? 'partial' : 'failed'
                    };

                    this.publishHistory.unshift(record);

                    // 只保留最近 50 条记录
                    if (this.publishHistory.length > 50) {
                        this.publishHistory = this.publishHistory.slice(0, 50);
                    }

                    this.savePublishHistory();
                },

                loadPublishHistory() {
                    const saved = localStorage.getItem('publish_history');
                    if (saved) {
                        try {
                            this.publishHistory = JSON.parse(saved);
                        } catch (error) {
                            console.error('加载发布历史失败:', error);
                            this.publishHistory = [];
                        }
                    }
                },

                savePublishHistory() {
                    localStorage.setItem('publish_history', JSON.stringify(this.publishHistory));
                },

                // Connection Status
                loadConnectionStatus() {
                    Object.keys(this.platforms).forEach(platform => {
                        const token = localStorage.getItem(`${platform}_token`);
                        if (token) {
                            this.platforms[platform].connected = true;
                        }
                    });
                },

                saveConnectionStatus() {
                    const status = {};
                    Object.keys(this.platforms).forEach(platform => {
                        status[platform] = this.platforms[platform].connected;
                    });
                    localStorage.setItem('connection_status', JSON.stringify(status));
                },

                // UI Helpers
                getRecommendedLength() {
                    if (this.selectedPlatforms.length === 0) return '根据平台选择';

                    const limits = this.selectedPlatforms.map(platform => this.platforms[platform].limit);
                    const minLimit = Math.min(...limits);
                    return `建议 ${minLimit} 字符以内`;
                },

                setDefaultScheduledTime() {
                    const now = new Date();
                    now.setHours(now.getHours() + 1);
                    this.scheduledTime = now.toISOString().slice(0, 16);
                },

                closeOAuthModal() {
                    this.showOAuthModal = false;
                    this.currentPlatform = null;
                },

                formatDate(dateString) {
                    const date = new Date(dateString);
                    return date.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                },

                getPlatformIcon(platform) {
                    return this.platforms[platform]?.icon || 'fas fa-question';
                },

                getPlatformName(platform) {
                    return this.platforms[platform]?.name || platform;
                },

                getStatusText(status) {
                    const statusMap = {
                        success: '发布成功',
                        failed: '发布失败',
                        partial: '部分成功',
                        pending: '等待发布'
                    };
                    return statusMap[status] || status;
                },

                delay(ms) {
                    return new Promise(resolve => setTimeout(resolve, ms));
                },

                showError(message) {
                    this.errorMessage = message;
                    this.successMessage = '';
                    setTimeout(() => {
                        this.errorMessage = '';
                    }, 5000);
                },

                showSuccess(message) {
                    this.successMessage = message;
                    this.errorMessage = '';
                    setTimeout(() => {
                        this.successMessage = '';
                    }, 3000);
                }
            }
        }
    </script>

    <style>
        [x-cloak] { display: none !important; }
    </style>
</body>
</html>
